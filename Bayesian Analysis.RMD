---
title: "Truncal Analgesia for Midline Laparotomy: A Bayesian SRMA, Metaregression and Trial Sequential Analysis"
output: html_document
date: "2023-05-15"
editor_options: 
  markdown: 
    wrap: 72
---

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
knitr::opts_chunk$set(echo = FALSE,	message = FALSE, warning = FALSE)

library(tidyverse)
library(metafor)

# Import the Data
truncal2 <- read.csv(paste0("Data/Data_Split_Multiarm_Trials 10_7_22.csv"))

#Clean Column Names & Remove 'et al.'
truncal2 <- truncal2 |>  
  janitor::clean_names() |> 
  mutate(author = stringr::str_remove(author, "et al."))

# Generate Subgroups for Meta Analysis
truncal2 <- truncal2 |>  
  mutate(subgroup = case_when(
    (intervention_type_intervention_1 == "Placebo") ~ "Placebo Vs Truncal Block",
    (intervention_type_intervention_1 == "Control") ~ "Control vs Truncal Block",
    (intervention_type_intervention_1 == "TEA") ~ "TEA Vs Truncal Block",
    (intervention_type_intervention_1 == "TAP") ~ "Intermittent Bolus Vs Continuous Infusion",
    (intervention_type_intervention_1 == "Wound") ~ "Wound Vs Truncal Block",
    (intervention_type_intervention_1 == "Quadratus Lumborum") ~ "Other"),
    subgroup = factor(subgroup,
                      levels = c("Control vs Truncal Block",
                                 "Placebo Vs Truncal Block",
                                 "TEA Vs Truncal Block",
                                 "Wound Vs Truncal Block",
                                 "Intermittent Bolus Vs Continuous Infusion",
                                 "Other")
    )
  )

# Create Function to Generate Dataframes for each outcome (eg Dynamic NRS at 24, 48, 72 hours, etc) and escalc()
var_select <- function(df, x, y, z){
  if(missing(x)) {
    varname1 <- paste({y}, "mean", {z}, "int1", sep = "_")} 
  else {varname1 <- paste({x}, {y}, "mean", {z}, "int1", sep = "_")}
  
  if(missing(x)) {
    varname2 <- paste({y}, "sd", {z}, "int1", sep = "_")} 
  else {varname2 <- paste({x}, {y}, "sd", {z}, "int1", sep = "_")}
  
  if(missing(x)) {
    varname3 <- paste({y}, "mean", {z}, "int2", sep = "_")} 
  else {varname3 <- paste({x}, {y}, "mean", {z}, "int2", sep = "_")}
  
  if(missing(x)) {
    varname4 <- paste({y}, "sd", {z}, "int2", sep = "_")}
  else {varname4 <- paste({x}, {y}, "sd", {z}, "int2", sep = "_")}  
  
  dat <- df |> 
    dplyr::select(author, year, intervention_type_intervention_1:intervention_type_intervention_2, subgroup, n_int1, n_int2, varname1:varname4) |> 
    drop_na()
  
  dat<- metafor::escalc(measure = "MD", n1i = n_int2, n2i = n_int1, m1i = dat[[varname3]], sd1i = dat[[varname4]], 
                        m2i = dat[[varname1]], sd2i = dat[[varname2]], data = dat) |> 
    mutate(sei = sqrt(vi)) |> 
    rename(
      m1i = varname3,
      sd1i = varname4,
      m2i = varname1,
      sd2i = varname2
    ) |> 
    mutate(outcome = {y}) |> 
    mutate(author1 = paste(author, year, sep = " ")) |> 
    select(author1, everything(), -author, -year)
  
  return(dat) 
}

# Create Dataframes for Each Outcome (ie Dynamic NRS at 24, 48, 72 Hours, etc)
dynamic_nrs_24 <- var_select(truncal2, "dynamic", "pain", "24h") 
dynamic_nrs_48 <- var_select(truncal2, "dynamic", "pain", "48h")
dynamic_nrs_72 <- var_select(truncal2, "dynamic", "pain", "72h")
static_nrs_24 <- var_select(truncal2, "static", "pain", "24h")
static_nrs_48 <- var_select(truncal2, "static", "pain", "48h")
static_nrs_72 <- var_select(truncal2, "static", "pain", "72h")
ome_24 <- var_select(truncal2, , "ome", "24h")
ome_48 <- var_select(truncal2, , "ome", "48h")
ome_72 <- var_select(truncal2, , "ome", "72h")

```

## The MA Model

The Bayesian meta-analytic (hierarchical) model is:

$$
\begin{align*}
y_i & \sim Normal(\theta_i, \sigma_i^2) \tag{Likelihood} \\
\theta_i & \sim Normal(\mu, \tau^2)\\
\mu & =  \alpha_{subgroup[k]}\\
\\
\alpha & \sim \operatorname{Normal}(0, 1) \tag{Priors} \\
\tau & \sim \operatorname{Half-Cauchy}(0, 0.5) \\
\end{align*}
$$ where $y_i$ is the observed mean difference in the dynamic numerical
rating scale (NRS) of truncal blocks versus non-truncal regional
analgesia for midline laparotomy, and $\sigma_i^2$ is the known sampling
variance in the study $i$. Each study, $i$ has it's own distribution
with a mean effect, $\theta_i$. $\theta_i$ is from a normal distribution
with a mean effect $\mu$ and variance $\tau^2$ (which represents the
between-study heterogeneity). The mean effect, $\mu$, is predicted by a
linear regression, where each subgroup $k$ (Control, Placebo, Thoracic
Epidural, Wound Catheter and Other) has it's own mean effect, given by
$\alpha$.

## Choice of Prior

#### Prior for Mean Difference

The mean difference in interventional pain studies can potentially have
no effect (mean difference = 0), or can result in total resolution of
pain (mean difference = 10). It is unlikley that a pain intervention
will result in improvement in NRS more than 5/10. However, it should
also be noted that if a pain intervention has no effect on acute pain, a
pain score may increase due to continued or worsening nociception,
resulting in a positive mean difference. Again,this is unlikely to
result in a mean difference of -10, and is less likely to exceed -5.
Hence, we will use a weakly informative prior for $\alpha$, ie
$Normal(0,1)$.

## Fit the Model

#### Dynamic Pain at 24 Hours- Overall

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
knitr::opts_chunk$set(echo = FALSE,	message = FALSE, warning = FALSE)

library(brms)
library(cmdstanr)
library(parallel)
library(tidybayes)
library(ggridges)
library(gt)

# First, set up priors for the brms model
priors <- c(prior(normal(0,1), class = Intercept),
            prior(cauchy(0,0.5), class = sd))

# Now we need to create a series of functions to avoid repeating code for each subgroup
## First, the brm function
brm_fn <- function(data, subgroup_filter)  {
  dat_surg_type_fn <- data|>
    filter(subgroup == subgroup_filter)

  # Run the brms model
  m.brm <- brm(yi | se(sei) ~ 1 + (1 | author1),
               data = dat_surg_type_fn,
               prior = priors,
               iter = 4000,
               cores = detectCores(),
               control = list(adapt_delta = 0.99),
               backend = "cmdstanr")
  return(m.brm)
}

# Now create the forest data function - this is used for density plots
forest.data_fn <- function(m.brm) {

  # Calculate the re-weighted estimated of each study
  study.draws <- spread_draws(m.brm, r_author1[author1, ], b_Intercept)|>
    mutate(b_Intercept = r_author1 + b_Intercept)

  # Establish the pooled result
  pooled.effect.draws <- spread_draws(m.brm, b_Intercept)|>
    mutate(author1 = "Pooled Effect")

  # Combine the pooled result with study estimates, then play around with the lexicon (brms mucks this up)
  forest.data <- bind_rows(study.draws,
                           pooled.effect.draws)|>
    ungroup()|>
    mutate(author1 = str_replace_all(author1, "[.]", " "),
           author1 = reorder(author1, b_Intercept))
  
  return(forest.data)
}


# Now create forest.data.summary function
forest.data.summary_fn <- function(data, subgroup_filter, forest.data) {
  dat_surg_type_fn <- data|>
    filter(subgroup == subgroup_filter)
  
  # Calculate mean qi based on author1
  forest.data.summary1 <- group_by(forest.data, author1)|>
    mean_qi(b_Intercept) 
  
  # Join the two dataframes based on similar author names
  forest.data.summary <- forest.data.summary1|>
    left_join(dat_surg_type_fn, by = "author1")|>
    mutate(n_int1_tot = as.character(ifelse(author1 == "Pooled Effect",
                                    sum(dat_surg_type_fn$n_int1),
                                    n_int1)),
         n_int2_tot = as.character(ifelse(author1 == "Pooled Effect",
                                        sum(dat_surg_type_fn$n_int2),
                                        n_int2)),
           author1 = as.factor(reorder(author1, b_Intercept)))
  
  return(forest.data.summary)
}


# Finally, make the res_plot function - this will be used for columns of means, SD's, etc.

res_plot_fn <- function(forest.data.summary, subgroup_filter, shrinkage_estimate, 
                        original_estimate, truncal_n_fn, truncal_mean_sd_fn, control_n_fn, control_mean_sd_fn, m.brm) { 
    # Extract the estimates for mu and tau
  post.samples <- as_draws_df(m.brm, c("b_Intercept", "sd_author1__Intercept"))
  
  ## Create the values for shrinkage and actual effect estimates
  res_plot_pre <- forest.data.summary|>
  mutate(weighted_effect = paste0(sprintf('%.2f', b_Intercept), 
                  ' [', sprintf('%.2f', .lower),
                  ', ', sprintf('%.2f', .upper), ']'),
         unweighted_effect = paste0(sprintf('%.2f', yi), 
                  ' [', sprintf('%.2f', yi - 1.96*sqrt(vi)),
                  ', ', sprintf('%.2f', yi + 1.96*sqrt(vi)), ']'))|>
   mutate(unweighted_effect = ifelse(unweighted_effect == "NA [NA, NA]", 
                                   paste0("Mean τ = ", 
                                          sprintf('%.2f', mean(post.samples$sd_author1__Intercept))), unweighted_effect),
          truncal_mean_sd = paste0(sprintf('%.2f', m2i), " (", sprintf('%.1f',sd2i), ")"),
          control_mean_sd = paste0(sprintf('%.2f', m1i), " (", sprintf('%.1f',sd1i), ")"))|>
    mutate(truncal_mean_sd = ifelse(truncal_mean_sd == "NA (NA)", "", truncal_mean_sd),
             control_mean_sd = ifelse(control_mean_sd == "NA (NA)", "", control_mean_sd))

# Add an additional row to the data for headings
  new_row <- data.frame(author1 = as.factor(subgroup_filter),
                      weighted_effect = shrinkage_estimate,
                      unweighted_effect = original_estimate,
                      n_int2_tot = truncal_n_fn,
                      truncal_mean_sd = truncal_mean_sd_fn,
                      n_int1_tot = control_n_fn,
                      control_mean_sd = control_mean_sd_fn)

  # Bind the new row with the previous dataframe and set the colours
  res_plot <- bind_rows(res_plot_pre, new_row)|>
          mutate(color = ifelse(author1 == "Pooled Effect", "grey60", "black"),
                 font = ifelse(author1 == "Pooled Effect", "bold", "plain"))

  return(res_plot)
}

## Now we need to run each subgroup through all the above functions
brm_control <- brm_fn(dynamic_nrs_24, "Control vs Truncal Block")
forest.data_control <- forest.data_fn(brm_control)
forest.data.summary_control <- forest.data.summary_fn(dynamic_nrs_24, "Control vs Truncal Block", forest.data_control)
res_plot_control <- res_plot_fn(forest.data.summary_control, "Control vs Truncal Block", "[95%CrI]", "[95%CrI]",
                              "n", "Mean (SD)", "n", "Mean (SD)", brm_control)

## Add an extra row to res_plot_control because we need more space at the top to fit our headings in
new_row_res_plot_control <- data.frame(author1 = as.factor("Subgroup"),
                      weighted_effect = "Shrinkage MD",
                      unweighted_effect = "Observed MD",
                      n_int2_tot = "Intervention",
                      truncal_mean_sd = "",
                      n_int1_tot = "Control",
                      control_mean_sd = "",
                      color = "black",
                      font = "plain")

res_plot_control <- bind_rows(res_plot_control, new_row_res_plot_control)

# Now, the placebo subgroup
brm_placebo <- brm_fn(dynamic_nrs_24, "Placebo Vs Truncal Block")
forest.data_placebo <- forest.data_fn(brm_placebo)
forest.data.summary_placebo <- forest.data.summary_fn(dynamic_nrs_24, "Placebo Vs Truncal Block", forest.data_placebo)
res_plot_placebo <- res_plot_fn(forest.data.summary_placebo, "Placebo Vs Truncal Block", "", "", "", "", "", "", brm_placebo)

# Now the TEA subgroup
brm_tea <- brm_fn(dynamic_nrs_24, "TEA Vs Truncal Block")
forest.data_tea <- forest.data_fn(brm_tea)
forest.data.summary_tea <- forest.data.summary_fn(dynamic_nrs_24, "TEA Vs Truncal Block", forest.data_tea)
res_plot_tea <- res_plot_fn(forest.data.summary_tea, "TEA Vs Truncal Block", "", "", "", "", "", "", brm_tea)

# Finally, the wound subgroup
brm_wound <- brm_fn(dynamic_nrs_24, "Wound Vs Truncal Block")
forest.data_wound <- forest.data_fn(brm_wound)
forest.data.summary_wound <- forest.data.summary_fn(dynamic_nrs_24, "Wound Vs Truncal Block", forest.data_wound)
res_plot_wound <- res_plot_fn(forest.data.summary_wound, "Wound Vs Truncal Block", "", "", "", "", "", "", brm_wound)

## First, control subgroup plots
## The first plot is the forest plot itself with shrinkage densities for each study

p_forest_control <- ggplot(aes(b_Intercept, 
           relevel(author1, "Pooled Effect", after=Inf)), 
       data = forest.data_control) +
  # Add vertical lines for pooled effect and CI
  geom_vline(xintercept = fixef(brm_control)[1, 1], 
             color = "grey60", size = 1) +
  geom_vline(xintercept = fixef(brm_control)[1, 3:4], 
             color = "grey60", linetype = 2) +
  geom_vline(xintercept = 0, color = "black", 
             size = 1) +
  # Add densities
  geom_density_ridges(fill = "#008cba", 
                      rel_min_height = 0.01, 
                      col = NA, scale = 0.9,
                      alpha = 0.8) +
  geom_pointinterval(data = forest.data.summary_control, 
                      linewidth = 1, color = "blue",
                     aes(xmin = .lower, xmax = .upper)) +
  geom_pointinterval(aes(xmin = yi - 1.96 * sqrt(vi), 
                          xmax = yi + 1.96 * sqrt(vi), 
                          x = yi),
                      position = position_nudge(y = -0.11),
                      data = forest.data.summary_control, 
                      linewidth = 1, 
                      col = "purple") +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2, 4, 6), expand = c(0,0)) +
  coord_cartesian(xlim=c(-6,6), ylim=c(1,8)) +
  annotate("text", x = -3.5, y = 7.5, label = "Favours\ntruncal block", fontface = "bold") +
  annotate("text", x = 4, y = 7.5,  label = "Favours\ncontrol", fontface = "bold") +
  theme_light() +
  theme(axis.line = element_blank(),           # remove axis lines
        axis.text.x = element_blank(),         # remove x-axis tick labels
        axis.ticks.x = element_blank(),        # remove x-axis ticks
        axis.text.y = element_blank()) +
  xlab(NULL) +
  ylab(NULL)

# The second plot shows the mean + 95%CrI for observed + shrinkage effects for each study

p_estimates_control <- ggplot(aes(y = relevel(author1, "Pooled Effect", after=Inf), color = color), 
                   data = res_plot_control) +
  geom_text(aes(x = 0, label = weighted_effect), hjust = 0,
            fontface = ifelse(grepl("Shrinkage MD|\\[95%CrI\\]", res_plot_control$weighted_effect), "bold", "plain")) + 
  geom_text(aes(x = 1, label = unweighted_effect), hjust = 0, 
            fontface = ifelse(grepl("Observed MD|\\[95%CrI\\]", res_plot_control$unweighted_effect), "bold", "plain")) +
  scale_color_identity() +
  theme_void() +
  coord_cartesian(xlim = c(0, 2), ylim=c(1,8))

# The third plot shows the study name, numbers in each group, and the relevant summary statistics
p_studies_control <- ggplot(aes(y = relevel(author1, "Pooled Effect", after=Inf), color = color), 
                          data = res_plot_control) +
  geom_text(aes(x = 0, label = author1), hjust = 0, 
            fontface = ifelse(res_plot_control$author1 == "Control vs Truncal Block" | res_plot_control$author1 == "Subgroup", "bold", 
                              ifelse(res_plot_control$author1 == "Pooled Effect", "italic","plain"))) +
  geom_text(aes(x = 1.5, label = n_int2_tot), hjust = 0, 
          fontface = ifelse(res_plot_control$n_int2_tot == "Intervention" | res_plot_control$n_int2_tot == "n", "bold", "plain")) +
  geom_text(aes(x = 2, label = truncal_mean_sd), hjust = 0, 
            fontface = ifelse(res_plot_control$truncal_mean_sd == "Mean (SD)", "bold", "plain")) +
  geom_text(aes(x = 3, label = n_int1_tot), hjust = 0, 
          fontface = ifelse(res_plot_control$n_int1_tot == "Control" |  res_plot_control$n_int1_tot == "n", "bold", "plain")) +
  geom_text(aes(x = 3.5, label = control_mean_sd), hjust = 0, 
            fontface = ifelse(res_plot_control$control_mean_sd == "Mean (SD)", "bold", "plain")) +
  scale_color_identity() + # Use the specified colors directly for text color
  theme_void() +
  coord_cartesian(xlim = c(0, 4), ylim=c(1,8))


## Now, the placebo subgroup - plots are as above

p_forest_placebo <- ggplot(aes(b_Intercept, 
           relevel(author1, "Pooled Effect", after=Inf)), 
       data = forest.data_placebo) +
  # Add vertical lines for pooled effect and CI
  geom_vline(xintercept = fixef(brm_placebo)[1, 1], 
             color = "grey60", size = 1) +
  geom_vline(xintercept = fixef(brm_placebo)[1, 3:4], 
             color = "grey60", linetype = 2) +
  geom_vline(xintercept = 0, color = "black", 
             size = 1) +
  # Add densities
  geom_density_ridges(fill = "#008cba", 
                      rel_min_height = 0.01, 
                      col = NA, scale = 0.9,
                      alpha = 0.8) +
  geom_pointinterval(data = forest.data.summary_placebo, 
                      linewidth = 1, color = "blue",
                     aes(xmin = .lower, xmax = .upper)) +
  geom_pointinterval(aes(xmin = yi - 1.96 * sqrt(vi), 
                          xmax = yi + 1.96 * sqrt(vi), 
                          x = yi),
                      position = position_nudge(y = -0.11),
                      data = forest.data.summary_placebo, 
                      linewidth = 1, 
                      col = "purple") +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2, 4, 6), expand = c(0,0)) +
  coord_cartesian(xlim=c(-6,6), ylim=c(1,11)) +
  theme_light() +
  theme(axis.line = element_blank(),           
        axis.text.x = element_blank(),         
        axis.ticks.x = element_blank(),    
        axis.text.y = element_blank()) +
  xlab(NULL) +
  ylab(NULL)

p_estimates_placebo <- ggplot(aes(y = relevel(author1, "Pooled Effect", after=Inf), color = color), 
                   data = res_plot_placebo) +
  geom_text(aes(x = 0, label = weighted_effect), hjust = 0) + 
  geom_text(aes(x = 1, label = unweighted_effect), hjust = 0) +
  theme_void() +
  scale_color_identity() +
  coord_cartesian(xlim = c(0, 2), ylim=c(1,11))

p_studies_placebo <- ggplot(aes(y = relevel(author1, "Pooled Effect", after=Inf), color = color), 
                   data = res_plot_placebo) +
  geom_text(aes(x = 0, label = author1), hjust = 0, fontface = ifelse(res_plot_placebo$author1 == "Placebo Vs Truncal Block", "bold", 
                                                                        ifelse(res_plot_placebo$author1 == "Pooled Effect", "italic","plain"))) +
  geom_text(aes(x = 1.5, label = n_int2_tot), hjust = 0) +
  geom_text(aes(x = 2, label = truncal_mean_sd), hjust = 0) +
  geom_text(aes(x = 3, label = n_int1_tot), hjust = 0) +
  geom_text(aes(x = 3.5, label = control_mean_sd), hjust = 0) +
  theme_void() +
  scale_color_identity() +
  coord_cartesian(xlim = c(0,4))

## Now, the TEA subgroup - plot descriptions as above

p_forest_tea <- ggplot(aes(b_Intercept, 
           relevel(author1, "Pooled Effect", after=Inf)), 
       data = forest.data_tea) +
  # Add vertical lines for pooled effect and CI
  geom_vline(xintercept = fixef(brm_tea)[1, 1], 
             color = "grey60", size = 1) +
  geom_vline(xintercept = fixef(brm_tea)[1, 3:4], 
             color = "grey60", linetype = 2) +
  geom_vline(xintercept = 0, color = "black", 
             size = 1) +
  # Add densities
  geom_density_ridges(fill = "#008cba", 
                      rel_min_height = 0.01, 
                      col = NA, scale = 0.9,
                      alpha = 0.8) +
  geom_pointinterval(data = forest.data.summary_tea, 
                      linewidth = 1, color = "blue",
                     aes(xmin = .lower, xmax = .upper)) +
  geom_pointinterval(aes(xmin = yi - 1.96 * sqrt(vi), 
                          xmax = yi + 1.96 * sqrt(vi), 
                          x = yi),
                      position = position_nudge(y = -0.11),
                      data = forest.data.summary_tea, 
                      linewidth = 1, 
                      col = "purple") +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2, 4, 6), expand = c(0,0)) +
  coord_cartesian(xlim=c(-6,6), ylim=c(1,9)) +
  theme_light() +
  theme(axis.line = element_blank(),           
        axis.text.x = element_blank(),         
        axis.ticks.x = element_blank(),    
        axis.text.y = element_blank()) +
  xlab(NULL) +
  ylab(NULL)


p_estimates_tea <- ggplot(aes(y = relevel(author1, "Pooled Effect", after=Inf), color = color), 
                   data = res_plot_tea) +
  geom_text(aes(x = 0, label = weighted_effect), hjust = 0) + 
  geom_text(aes(x = 1, label = unweighted_effect), hjust = 0) +
  theme_void() +
  scale_color_identity() +
  coord_cartesian(xlim = c(0, 2), ylim=c(1,9))

p_studies_tea <- ggplot(aes(y = relevel(author1, "Pooled Effect", after=Inf), color = color), 
                   data = res_plot_tea) +
  geom_text(aes(x = 0, label = author1), hjust = 0, fontface = ifelse(res_plot_tea$author1 == "TEA Vs Truncal Block", "bold", 
                                                                        ifelse(res_plot_tea$author1 == "Pooled Effect", "italic","plain"))) +
  geom_text(aes(x = 1.5, label = n_int2_tot), hjust = 0) +
  geom_text(aes(x = 2, label = truncal_mean_sd), hjust = 0) +
  geom_text(aes(x = 3, label = n_int1_tot), hjust = 0) +
  geom_text(aes(x = 3.5, label = control_mean_sd), hjust = 0) +
  theme_void() +
  scale_color_identity() +
  coord_cartesian(xlim = c(0,4))

## Then, the wound subgroup - again, plots are as above

p_forest_wound <- ggplot(aes(b_Intercept, 
           relevel(author1, "Pooled Effect", after=Inf)), 
       data = forest.data_wound) +
  # Add vertical lines for pooled effect and CI
  geom_vline(xintercept = fixef(brm_wound)[1, 1], 
             color = "grey60", size = 1) +
  geom_vline(xintercept = fixef(brm_wound)[1, 3:4], 
             color = "grey60", linetype = 2) +
  geom_vline(xintercept = 0, color = "black", 
             size = 1) +
  # Add densities
  geom_density_ridges(fill = "#008cba", 
                      rel_min_height = 0.01, 
                      col = NA, scale = 0.9,
                      alpha = 0.8) +
  geom_pointinterval(data = forest.data.summary_wound, 
                      linewidth = 1, color = "blue",
                     aes(xmin = .lower, xmax = .upper)) +
  geom_pointinterval(aes(xmin = yi - 1.96 * sqrt(vi), 
                          xmax = yi + 1.96 * sqrt(vi), 
                          x = yi),
                      position = position_nudge(y = -0.11),
                      data = forest.data.summary_wound, 
                      linewidth = 1, 
                      col = "purple") +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2, 4, 6), expand = c(0,0)) +
  coord_cartesian(xlim=c(-6,6), ylim=c(1,5)) +
  theme_light() +
  theme(axis.line = element_blank(),           
        axis.text.x = element_blank(),         
        axis.ticks.x = element_blank(),    
        axis.text.y = element_blank()) +
  xlab(NULL) +
  ylab(NULL)


p_estimates_wound <- ggplot(aes(y = relevel(author1, "Pooled Effect", after=Inf), color = color), 
                   data = res_plot_wound) +
  geom_text(aes(x = 0, label = weighted_effect), hjust = 0) + 
  geom_text(aes(x = 1, label = unweighted_effect), hjust = 0) +
  theme_void() +
  scale_color_identity() +
  coord_cartesian(xlim = c(0, 2), ylim=c(1,5))

p_studies_wound <- ggplot(aes(y = relevel(author1, "Pooled Effect", after=Inf), color = color), 
                   data = res_plot_wound) +
  geom_text(aes(x = 0, label = author1), hjust = 0, fontface = ifelse(res_plot_wound$author1 == "Wound Vs Truncal Block", "bold", 
                                                                        ifelse(res_plot_wound$author1 == "Pooled Effect", "italic","plain"))) +
  geom_text(aes(x = 1.5, label = n_int2_tot), hjust = 0) +
  geom_text(aes(x = 2, label = truncal_mean_sd), hjust = 0) +
  geom_text(aes(x = 3, label = n_int1_tot), hjust = 0) +
  geom_text(aes(x = 3.5, label = control_mean_sd), hjust = 0) +
  theme_void() +
  scale_color_identity() +
  coord_cartesian(xlim = c(0,4))

## Finally, overall effect size 
## We must construct this separately as the functions above won't work
## I've essentially re-written the functions but scrapped all the stuff above individual studies

dat_overall <- dynamic_nrs_24

brm_overall <- brm(yi|se(sei) ~ 1 + (1|author1),
             data = dat_overall,
             prior = priors,
             iter = 4000,
             control = list(adapt_delta = 0.99),
             cores = parallel::detectCores(),
             backend = "cmdstanr")

post.samples_overall <- as_draws_df(brm_overall, c("b_Intercept", "sd_author1__Intercept"))

study.draws_overall <- spread_draws(brm_overall, r_author1[author1,], b_Intercept)|> 
  mutate(b_Intercept = r_author1 + b_Intercept)

pooled.effect.draws_overall <- spread_draws(brm_overall, b_Intercept)|> 
  mutate(author1 = "Pooled Effect")

forest.data_overall <- pooled.effect.draws_overall|> 
   ungroup()|>
   mutate(author1 = str_replace_all(author1, "[.]", " "))|> 
   mutate(author1 = reorder(author1, b_Intercept))

forest.data.summary_overall <- group_by(forest.data_overall, author1)|> 
  mean_qi(b_Intercept) 

res_plot <- forest.data.summary_overall|>
  mutate(weighted_effect = paste0(sprintf('%.2f', b_Intercept), 
                  ' [', sprintf('%.2f', .lower),
                  ', ', sprintf('%.2f', .upper), ']'),
          unweighted_effect = paste0("Mean τ = ", 
                                          sprintf('%.2f', mean(post.samples_overall$sd_author1__Intercept))),
         n_int1_tot = as.character(sum(dynamic_nrs_24$n_int1)),
         n_int2_tot = as.character(sum(dynamic_nrs_24$n_int2)),
         truncal_mean_sd = "",
        control_mean_sd = "",
         colour = "grey60")

new_row <- data.frame(author1 = as.factor("Overall"),
                      weighted_effect = "",
                      unweighted_effect = "",
                      n_int1_tot = "",
                      n_int2_tot = "",
                      truncal_mean_sd = "",
                      control_mean_sd = "",
                      colour = "black")

res_plot_overall <- bind_rows(res_plot, new_row)

## Now make the overall plot

p_forest_overall <- ggplot(aes(b_Intercept, 
           relevel(author1, "Pooled Effect", after=Inf)), 
       data = forest.data_overall) +
  # Add vertical lines for pooled effect and CI
  geom_vline(xintercept = fixef(brm_overall)[1, 1], 
             color = "grey60", size = 1) +
  geom_vline(xintercept = fixef(brm_overall)[1, 3:4], 
             color = "grey60", linetype = 2) +
  geom_vline(xintercept = 0, color = "black", 
             size = 1) +
  # Add densities
  geom_density_ridges(fill = "#008cba", 
                      rel_min_height = 0.01, 
                      col = NA, scale = 0.9,
                      alpha = 0.8) +
  geom_pointinterval(data = forest.data.summary_overall, 
                      linewidth = 1, color = "blue",
                      position = position_nudge(y = -0.11),
                     aes(xmin = .lower, xmax = .upper)) +
  scale_x_continuous(breaks = c(-6, -4, -2, 0, 2, 4, 6), expand = c(0,0)) +
  coord_cartesian(xlim=c(-6,6), ylim=c(1,3)) +
  theme_light() +
  theme(axis.text.y = element_blank()) +
  labs(x="Mean difference") +
  ylab(NULL)

p_estimates_overall <- ggplot(aes(y = relevel(author1, "Pooled Effect", after=Inf), colour = colour), 
                   data = res_plot_overall) +
  geom_text(aes(x = 0, label = weighted_effect), hjust = 0) + 
  geom_text(aes(x = 1, label = unweighted_effect), hjust = 0) +
  theme_void() +
  scale_color_identity() +
  coord_cartesian(xlim = c(0, 2), ylim=c(1,3))

p_studies_overall <- ggplot(aes(y = relevel(author1, "Pooled Effect", after=Inf), colour = colour), 
                   data = res_plot_overall) +
  geom_text(aes(x = 0, label = author1), hjust = 0, fontface = ifelse(res_plot_overall$author1 == "Overall", "bold",
                                                                      ifelse(res_plot_overall$author1 == "Pooled Effect", "italic","plain"))) +
  geom_text(aes(x = 1.5, label = n_int2_tot), hjust = 0) +
  geom_text(aes(x = 2, label = truncal_mean_sd), hjust = 0) +
  geom_text(aes(x = 3, label = n_int1_tot), hjust = 0) +
  geom_text(aes(x = 3.5, label = control_mean_sd), hjust = 0) +
  theme_void() +
  scale_color_identity() +
  coord_cartesian(xlim = c(0,4))



library(patchwork)

## Create a layout that we will pass to the patchwork package to size all our plots
## The vertical axis needs to be adjusted depending on the number of studies in each subgroup
layout <- c(
  area(t = 0, l = 0, b = 16, r = 45),
  area(t = 0, l = 45, b = 16, r = 65), 
  area(t = 0, l = 67, b = 16, r = 88),
  area(t = 17, l = 0, b = 36, r = 45),
  area(t = 17, l = 45, b = 36, r = 65), 
  area(t = 17, l = 67, b = 36, r = 88),
  area(t = 37, l = 0, b = 52, r = 45),
  area(t = 37, l = 45, b = 52, r = 65), 
  area(t = 37, l = 67, b = 52, r = 88),
  area(t = 53, l = 0, b = 61, r = 45),
  area(t = 53, l = 45, b = 61, r = 65), 
  area(t = 53, l = 67, b = 61, r = 88),
  area(t = 62, l = 0, b = 64, r = 45),
  area(t = 62, l = 45, b = 64, r = 65), 
  area(t = 62, l = 67, b = 64, r = 88))


# Finally, combine all the plots together
p_studies_control + p_forest_control + p_estimates_control + 
  p_studies_placebo + p_forest_placebo + p_estimates_placebo + 
  p_studies_tea + p_forest_tea + p_estimates_tea +
  p_studies_wound + p_forest_wound + p_estimates_wound +
  p_studies_overall + p_forest_overall + p_estimates_overall + plot_layout(design = layout)


# Bivariate Outcome for Dynamic Pain and OME at 24 Hours
# Bind Pain and OME dataframes together
pain_ome_24h <- rbind(dynamic_nrs_24, ome_24)

# Construct a variance-covariance matrix assuming within-study correlation = 0.5
V <- metafor::vcalc(vi, cluster=author1, type=outcome, rho=0.5, data= pain_ome_24h)

# Specify formula
mf <-  brms::bf(yi ~ 0 + outcome + (0 + outcome|author1) + fcor(V))

get_prior(mf, 
          data = pain_ome_24h,
          data2 = list(V = V),
          family = gaussian)

# Create priors
priors_bv =  
  prior(normal(0, 4), class = "b", coef = "outcomeome") +
  prior(normal(0, 4), class = "b", coef = "outcomepain") +
  prior(cauchy(0, 4), class = "sd", coef = "outcomepain", group = "author1") +
  prior(cauchy(0, 4), class = "sd", coef = "outcomeome", group = "author1") +
  prior(lkj(2), class = cor) +
  prior(constant(1), class = "sigma")

# Run the analysis
brm_pain_ome_24_bv <- brms::brm(
  formula = mf,
  prior = priors_bv,
  data = pain_ome_24h,
  data2 = list(V = V),
  family = gaussian,
  warmup = 2000, 
  iter = 4000,
  chains = 4,
  cores = parallel::detectCores(),
  control = list(adapt_delta = 0.99),
  backend = "cmdstanr",
  seed = 123)

#Extract medians and 95% HDIs for means/SDs for each outcome & tabulate
parameters <- 
  brm_pain_ome_24_bv |> 
  tidy_draws() |> 
  reframe("ATE: Pain" = b_outcomepain,
          "ATE: Opioid Use" = b_outcomeome,
            
          "Tau: Pain" = sd_author1__outcomepain,
          "Tau: Opioid Use" = sd_author1__outcomeome,
            
          "Correlation" = cor_author1__outcomeome__outcomepain) |> 
  pivot_longer(everything()) |> 
  group_by(name) |> 
  median_hdi(value) |> 
  mutate(across(value:.upper, ~round(., 2))) |> 
  select(-c(.width:.interval))

# Tabulate the above data
pain_ome_24h_bv_parameters <- parameters |> 
  filter(str_detect(name, "ATE")) |> 
  mutate(across(-name, ~round(., 2))) |> 
  reframe(Parameter = name, 
          "Median [95% CrI]" = str_c(value, " [", .lower, ", ", .upper, "]")) |> 
  rbind(
    parameters |> 
    filter(str_detect(name, "ATE", negate = T)) |> 
    reframe(Parameter = name, 
            "Median [95% CrI]" = str_c(value, " [", .lower, ", ", .upper, "]"))
  ) |> 
  gt()

# Bivariate Plot
pain_ome_bvplot <- brm_pain_ome_24_bv |> 
  tidybayes::tidy_draws() |> 
  ggplot() +
  aes(x = b_outcomepain, y = b_outcomeome) +
  ggdensity::geom_hdr(
    probs = c(0.95, 0.8, 0.5),
    aes(fill = after_stat(probs)), 
    alpha = 1
  ) +
  scale_fill_manual(values = c("pink", "red", "darkred")) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  scale_x_continuous(breaks = c(-1.5, -1, -0.5, 0, 0.5)) +
  scale_y_continuous(breaks = c(-12, -8, -4, 0, 4, 8)) +
  coord_cartesian(xlim=c(-1.2,0.5), ylim=c(-13,8)) +
  labs(x = "Mean difference in pain (dynamic NRS)",
       y = "Mean difference in opioid use (oral morphine equivalents)") +
  geom_text(aes(x = 0.1, y = 4, label = "Favours\ncontrol"), hjust = 0) +
  geom_text(aes(x = -1.2, y = -11, label = "Favours\ntruncal block"), hjust = 0) +
  ggdist::theme_ggdist()

# Probabilities
prob_tbl <- brm_pain_ome_24_bv |> 
  tidybayes::tidy_draws() |> 
  reframe(q1 = mean(b_outcomepain < 0 & b_outcomeome < 0),
          q2 = mean(b_outcomepain < 0 & b_outcomeome > 0),
          q3 = mean(b_outcomepain > 0 & b_outcomeome < 0),
          q4 = mean(b_outcomepain > 0 & b_outcomeome > 0)) |> 
  mutate(across(everything(), ~round(., 2))) |> 
  mutate("Pain MD < 0 & Opioid MD < 0" = q1,
           "Pain MD < 0 & Opioid MD > 0" = q2,
           "Pain MD > 0 & Opioid MD < 0" = q3,
           "Pain MD > 0 & Opioid MD > 0" = q4) |> 
  select(-c(q1, q2, q3, q4)) |> 
  pivot_longer(everything()) |> 
  rename(c("Outcome" = name,
           Probability = value)) |> 
  gt() |> 
  tab_header(title = "Bivariate Outcome of Dynamic Pain & Opioid Use at 24 Hours") |> 
  tab_footnote(footnote = "Pain MD = Mean Difference in Dynamic Numerical Pain Scale") |> 
  tab_footnote(footnote = "Opioid MD = Mean Difference in Oral Morphine Equivalents")

```

## Subgroup Analyses

#### Single Shot Truncal Blocks & Continuous Infusions: Overall

```{r}

# Select Studies with Single Shot Truncal Blocks
truncal_ss <- truncal2 |> 
    filter((dose_schedule_intervention_1 == "Single Shot") |
         (dose_schedule_intervention_2 == "Single Shot"))

# Create Dataframes for Each Outcome
dynamic_nrs_24_ss <- var_select(truncal_ss, "dynamic", "pain", "24h") 
dynamic_nrs_48_ss <- var_select(truncal_ss, "dynamic", "pain", "48h")
# Dynamic NRS 72 Hours -> No observations
ome_24_ss <- var_select(truncal_ss, , "ome", "24h")
ome_48_ss <- var_select(truncal_ss, , "ome", "48h")
# OME 72 Hours -> No observations

# Function to Run Bayesian MA
brm_ma <- function(data){
    m.brm <- brm(yi | se(sei) ~ 1 + (1 | author1),
               data = data,
               prior = priors,
               iter = 4000,
               cores = detectCores(),
               control = list(adapt_delta = 0.99),
               backend = "cmdstanr",
               seed = 1234)
  return(m.brm)
}

#Extract medians and 95% HDIs for means/SDs for each outcome
parameters <- function(data){
  data |> 
  tidy_draws() |> 
  reframe("ATE: Pain" = b_Intercept) |> 
  pivot_longer(everything()) |> 
  group_by(name) |> 
  median_hdi(value) |> 
  mutate(across(value:.upper, ~round(., 2))) |> 
  select(-c(.width:.interval))
}

# Tabulate Data
table <- function(data){
  data |>
  mutate(across(-c(name, Outcome, Time, subgroup), ~round(., 2))) |> 
  reframe(Outcome = Outcome, subgroup, Time,
          "Median [95% CrI]" = str_c(value, " [", .lower, ", ", .upper, "]"))
}

# Determine Overall Effect for Each Outcome
brm_dyn_nrs_24_ss <- brm_ma(dynamic_nrs_24_ss) |> parameters() |> mutate(Outcome = "Dynamic Pain", Time = "24H", subgroup = "Single Shot") |> table()
brm_dyn_nrs_48_ss <- brm_ma(dynamic_nrs_48_ss) |> parameters() |> mutate(Outcome = "Dynamic Pain", Time = "48H", subgroup = "Single Shot") |> table()
brm_ome_24_ss <- brm_ma(ome_24_ss) |> parameters() |> mutate(Outcome = "OME", Time = "24H", subgroup = "Single Shot") |> table()
brm_ome_48_ss <- brm_ma(ome_48_ss) |> parameters() |> mutate(Outcome = "OME", Time = "48H", subgroup = "Single Shot") |> table()

# Remove Studies with Single Shot Truncal Blocks
truncal_cont <- truncal2 |> 
        filter(!(dose_schedule_intervention_1 == "Single Shot")) |> 
        filter(!(dose_schedule_intervention_2 == "Single Shot"))

# Create Dataframes for Each Outcome
#dynamic_nrs_24_cont <- var_select(truncal_cont, "dynamic", "pain", "24h") 
#dynamic_nrs_48_cont <- var_select(truncal_cont, "dynamic", "pain", "48h")
#dynamic_nrs_72_cont <- var_select(truncal_cont, "dynamic", "pain", "72h")
#ome_24_cont <- var_select(truncal_cont, , "ome", "24h")
#ome_48_cont <- var_select(truncal_cont, , "ome", "48h")
#ome_72_cont <- var_select(truncal_cont, , "ome", "72h")


# Determine Overall Effect for Each Outcome
#brm_dyn_nrs_24_cont <- brm_ma(dynamic_nrs_24_cont) |> parameters() |> mutate(Outcome = "Dynamic Pain: Continuous Infusion", Time = "24H") |> table()
#brm_dyn_nrs_48_cont <- brm_ma(dynamic_nrs_48_cont) |> parameters() |> mutate(Outcome = "Dynamic Pain: Continuous Infusion", Time = "48H") |> table()
#brm_dyn_nrs_72_cont <- brm_ma(dynamic_nrs_72_cont) |> parameters() |> mutate(Outcome = "Dynamic Pain: Continuous Infusion", Time = "72H") |> table()
#brm_ome_24_cont <- brm_ma(ome_24_cont) |> parameters() |> mutate(Outcome = "OME: Continuous Infusion", Time = "24H") |> table()
#brm_ome_48_cont <- brm_ma(ome_48_cont) |> parameters() |> mutate(Outcome = "OME: Continuous Infusion", Time = "48H") |> table()
#brm_ome_72_cont <- brm_ma(ome_72_cont) |> parameters() |> mutate(Outcome = "OME: Continuous Infusion", Time = "72H") |> table()

```

#### Placebo Continuous Infusions

```{r}

# Look at Placebo Continuous Infusions
truncal_cont_placebo <- truncal_cont |> 
  filter(intervention_type_intervention_1 == "Placebo")

# Create Dataframes for Each Outcome
dynamic_nrs_24_cont_pl <- var_select(truncal_cont_placebo, "dynamic", "pain", "24h")
dynamic_nrs_48_cont_pl <- var_select(truncal_cont_placebo, "dynamic", "pain", "48h") 
dynamic_nrs_72_cont_pl <- var_select(truncal_cont_placebo, "dynamic", "pain", "72h") 
ome_24_cont_pl <- var_select(truncal_cont_placebo, , "ome", "24h")
ome_48_cont_pl <- var_select(truncal_cont_placebo, , "ome", "48h")
ome_72_cont_pl <- var_select(truncal_cont_placebo, , "ome", "72h")

# Determine Overall Effect for Each Outcome
brm_dyn_nrs_24_cont_pl <- brm_ma(dynamic_nrs_24_cont_pl) |> parameters() |> mutate(Outcome = "Dynamic Pain", Time = "24H", subgroup = "Continuous Placebo Infusion") |> table()
brm_dyn_nrs_48_cont_pl <- brm_ma(dynamic_nrs_48_cont_pl) |> parameters() |> mutate(Outcome = "Dynamic Pain", Time = "48H", subgroup = "Continuous Placebo Infusion") |> table()
brm_dyn_nrs_72_cont_pl <- brm_ma(dynamic_nrs_72_cont_pl) |> parameters() |> mutate(Outcome = "Dynamic Pain", Time = "72H", subgroup = "Continuous Placebo Infusion") |> table()
brm_ome_24_cont_pl <- brm_ma(ome_24_cont_pl) |> parameters() |> mutate(Outcome = "OME", Time = "24H", subgroup = "Continuous Placebo Infusion") |> table()
brm_ome_48_cont_pl <- brm_ma(ome_48_cont_pl) |> parameters() |> mutate(Outcome = "OME", Time = "48H", subgroup = "Continuous Placebo Infusion") |> table()
brm_ome_72_cont_pl <- brm_ma(ome_72_cont_pl) |> parameters() |> mutate(Outcome = "OME", Time = "72H", subgroup = "Continuous Placebo Infusion") |> table()

```

#### Thoracic Epidural

```{r}

# Look at TEA
truncal_cont_tea <- truncal_cont |> 
  filter(intervention_type_intervention_1 == "TEA")

# Create Dataframes for Each Outcome
dynamic_nrs_24_cont_tea <- var_select(truncal_cont_tea, "dynamic", "pain", "24h")
dynamic_nrs_48_cont_tea <- var_select(truncal_cont_tea, "dynamic", "pain", "48h") 
dynamic_nrs_72_cont_tea <- var_select(truncal_cont_tea, "dynamic", "pain", "72h") 
ome_24_cont_tea <- var_select(truncal_cont_tea, , "ome", "24h")
ome_48_cont_tea <- var_select(truncal_cont_tea, , "ome", "48h")
ome_72_cont_tea <- var_select(truncal_cont_tea, , "ome", "72h")

# Determine Overall Effect for Each Outcome
brm_dyn_nrs_24_cont_tea <- brm_ma(dynamic_nrs_24_cont_tea) |> parameters() |> mutate(Outcome = "Dynamic Pain", Time = "24H", subgroup = "Thoracic Epidural") |> table()
brm_dyn_nrs_48_cont_tea <- brm_ma(dynamic_nrs_48_cont_tea) |> parameters() |> mutate(Outcome = "Dynamic Pain", Time = "48H", subgroup = "Thoracic Epidural") |> table()
brm_dyn_nrs_72_cont_tea <- brm_ma(dynamic_nrs_72_cont_tea) |> parameters() |> mutate(Outcome = "Dynamic Pain", Time = "72H", subgroup = "Thoracic Epidural") |> table()
brm_ome_24_cont_tea <- brm_ma(ome_24_cont_tea) |> parameters() |> mutate(Outcome = "OME", Time = "24H", subgroup = "Thoracic Epidural") |> table()
brm_ome_48_cont_tea <- brm_ma(ome_48_cont_tea) |> parameters() |> mutate(Outcome = "OME", Time = "48H", subgroup = "Thoracic Epidural") |> table()
brm_ome_72_cont_tea <- brm_ma(ome_72_cont_tea) |> parameters() |> mutate(Outcome = "OME", Time = "72H", subgroup = "Thoracic Epidural") |> table()

```

#### Wound Infusion

```{r}

#Look at Wound Infusions
truncal_cont_wound <- truncal_cont |> 
  filter(intervention_type_intervention_1 == "Wound")

# Create Dataframes for Each Outcome
dynamic_nrs_24_cont_wound <- var_select(truncal_cont_wound, "dynamic", "pain", "24h")
dynamic_nrs_48_cont_wound <- var_select(truncal_cont_wound, "dynamic", "pain", "48h") 
dynamic_nrs_72_cont_wound <- var_select(truncal_cont_wound, "dynamic", "pain", "72h") 
ome_24_cont_wound <- var_select(truncal_cont_wound, , "ome", "24h")
ome_48_cont_wound <- var_select(truncal_cont_wound, , "ome", "48h")
ome_72_cont_wound <- var_select(truncal_cont_wound, , "ome", "72h")

# Determine Overall Effect for Each Outcome
brm_dyn_nrs_24_cont_wound <- brm_ma(dynamic_nrs_24_cont_wound) |> parameters() |> mutate(Outcome = "Dynamic Pain", Time = "24H", subgroup = "Wound Infusion") |> table()
brm_dyn_nrs_48_cont_wound <- brm_ma(dynamic_nrs_48_cont_wound) |> parameters() |> mutate(Outcome = "Dynamic Pain", Time = "48H", subgroup = "Wound Infusion") |> table()
brm_dyn_nrs_72_cont_wound <- brm_ma(dynamic_nrs_72_cont_wound) |> parameters() |> mutate(Outcome = "Dynamic Pain", Time = "72H", subgroup = "Wound Infusion") |> table()
brm_ome_24_cont_wound <- brm_ma(ome_24_cont_wound) |> parameters() |> mutate(Outcome = "OME", Time = "24H", subgroup = "Wound Infusion") |> table()
brm_ome_48_cont_wound <- brm_ma(ome_48_cont_wound) |> parameters() |> mutate(Outcome = "OME", Time = "48H", subgroup = "Wound Infusion") |> table()
brm_ome_72_cont_wound <- brm_ma(ome_72_cont_wound) |> parameters() |> mutate(Outcome = "OME", Time = "72H", subgroup = "Wound Infusion") |> table()

```

#### All Subgroups- Single Shot, Continuous Placebo Infusions, Thoracic Epidural

```{r}

Subgroup_MA <-
  rbind(brm_dyn_nrs_24_ss, brm_dyn_nrs_48_ss, brm_ome_24_ss, brm_ome_48_ss, brm_dyn_nrs_24_cont_pl, brm_dyn_nrs_48_cont_pl, brm_dyn_nrs_72_cont_pl, brm_ome_24_cont_pl, brm_ome_48_cont_pl, brm_ome_72_cont_pl, brm_dyn_nrs_24_cont_tea, brm_dyn_nrs_48_cont_tea, brm_dyn_nrs_72_cont_tea, brm_ome_24_cont_tea, brm_ome_48_cont_tea, brm_ome_72_cont_tea, brm_dyn_nrs_24_cont_wound, brm_dyn_nrs_48_cont_wound, brm_dyn_nrs_72_cont_wound, brm_ome_24_cont_wound, brm_ome_48_cont_wound, brm_ome_72_cont_wound, by = 'Outcome')

# Create Table
 subgroup_tbl_overall <- Subgroup_MA |> 
  group_by(subgroup, Outcome) |> 
  mutate(Count = 1:n()) |> 
  pivot_wider(id_cols = c(Outcome, subgroup),
              values_from = `Median [95% CrI]`,
              names_from = Count) |> 
  rename(c("24 Hours" = "1", "48 Hours" = "2", "72 Hours" = "3")) |> 
  filter(Outcome != "Outcome") |> 
  gt(groupname_col = c("subgroup"))|>  
  tab_stubhead(label = "Subgroup") |>  
  tab_options(
    row_group.as_column = TRUE,
    row_group.border.top.width = px(3),
    row_group.font.weight = "bold",
    table.border.bottom.width = px(3),
    table.border.bottom.color = "black",
    table.border.top.color = "white",
    heading.border.bottom.color = "black",
    heading.border.bottom.width = px(3),
    heading.title.font.weight = "bold") |> 
  tab_header(title = "Average Treatment Effect (ATE)")|>
  opt_align_table_header(align = "left") |> 
  tab_style(
    style = cell_borders(
      sides = "right",
      weight = px(3),
      color = "light grey"),
    locations = cells_body(
      columns = c(Outcome, "24 Hours", "48 Hours"))) |> 
   tab_footnote(
     footnote = "Values given as Median [95% Credible Interval]",
     locations = cells_column_labels(columns = c("24 Hours", "48 Hours", "72 Hours")))
   

```

## Forest Plots

```{r}

```

## Secondary Outcomes

```{r}
library(gtsummary)
library(bstfun)

# Select Surgical Outcome Data
surg_outcomes <- truncal2 |>  
  select(author, intervention_type_intervention_1:intervention_type_intervention_2, first_bowel_int1:ileus_int2)

# Create Table of Surgical Outcomes
surg_outcomes_cont <- surg_outcomes |>  
  select(hosp_los_int1, first_bs_int1, time_ambulation_int1, ileus_int1) |>  
  rename("Hospital LOS" = hosp_los_int1,
         "Time to First Bowel Sounds (Hrs)" = first_bs_int1,
         "Time to Ambulation (Hrs)" = time_ambulation_int1,
         "Ileus" = ileus_int1) |>  
  mutate_all(as.numeric) |>  
  mutate(Intervention = "Control")

surg_outcomes_int <- surg_outcomes |>  
  select(hosp_los_int2, first_bs_int2, time_ambulation_int2, ileus_int2) |>  
  rename("Hospital LOS" = hosp_los_int2,
         "Time to First Bowel Sounds (Hrs)" = first_bs_int2,
         "Time to Ambulation (Hrs)" = time_ambulation_int2,
         "Ileus" = ileus_int2) |>  
  mutate_all(as.numeric) |>  
  mutate(Intervention = "Truncal Block")

surg_outcomes_total <- rbind(surg_outcomes_cont, surg_outcomes_int)

table_surg_outcome <- surg_outcomes_total |>  
  select("Hospital LOS":"Intervention") |>  
  tbl_summary(by = "Intervention", missing = "no",
              type = everything() ~ "continuous") |>  
  modify_spanning_header(starts_with("stat_") ~ "**Intervention**")

# Select Procedure Morbidity Data
procedure_morb <- truncal2|> 
  select(author, intervention_type_intervention_1:intervention_type_intervention_2, procedure_compl_int1, procedure_compl_int2, block_failure_int1, block_failure_int2)

# Create Table of Procedural Morbidity
proc_morb_cont <- procedure_morb|>
  select(procedure_compl_int1, block_failure_int1)|>
  rename("Procedural Complication" = procedure_compl_int1,
         "Block Failure" = block_failure_int1)|>
  mutate_all(as.numeric)|>
  mutate(Intervention = "Control")

proc_morb_int <- procedure_morb|>
  select(procedure_compl_int2, block_failure_int2)|>
  rename("Procedural Complication" = procedure_compl_int2,
         "Block Failure" = block_failure_int2)|>
  mutate_all(as.numeric)|>
  mutate(Intervention = "Truncal Block")

proc_morb_total <- rbind(proc_morb_cont, proc_morb_int)

table_proc_morb <- proc_morb_total|>
  select("Procedural Complication":"Intervention")|>
  tbl_summary(by = "Intervention", missing = "no",
              type = everything() ~ "continuous")|>
  modify_spanning_header(starts_with("stat_") ~ "**Intervention**")

# Select Opioid Side Effect Data
opioid_se <- truncal2|>
  select(author, intervention_type_intervention_1:intervention_type_intervention_2, sedation_int1:pruritis_int1, sedation_int2:pruritis_int2, -c(procedure_compl_int1, procedure_compl_int2))

# Create Table of Opioid Side Effects

opioid_se_cont <- opioid_se|>
  select(sedation_int1:pruritis_int1)|>
  rename("Sedation" = sedation_int1,
         "Nausea & Vomiting" = nv_int1,
         "Hypotension" = hypotension_int1,
         "Pruritis" = pruritis_int1)|>
  mutate_all(as.numeric)|>
  mutate(Intervention = "Control")

opioid_se_int <- opioid_se|>
  select(sedation_int2:pruritis_int2)|>
  rename("Sedation" = sedation_int2,
         "Nausea & Vomiting" = nv_int2,
         "Hypotension" = hypotension_int2,
         "Pruritis" = pruritis_int2)|>
  mutate_all(as.numeric)|>
  mutate(Intervention = "Truncal Block")

opioid_se_total <- rbind(opioid_se_cont, opioid_se_int)

table_opioid_se <- opioid_se_total|>
  select("Sedation":"Intervention")|>
  tbl_summary(by = "Intervention", missing = "no",
              type = everything() ~ "continuous")|>
  modify_spanning_header(starts_with("stat_") ~ "**Intervention**")

# Merge Secondary Outcomes Tables
sec_outcomes <- tbl_stack(list(table_surg_outcome, table_proc_morb, table_opioid_se),
                          group_header = c("Surgical Outcomes", "Procedural Morbidity", "Opioid Side Effects"))

```

## Sensitivity Analysis

We performed a sensitivity analysis using different combinations of
priors. For each parameter ($\alpha$ and $\tau$) we used three different
types of prior:

1.  Weakly-Informative (Priors used for our main model)

2.  Vague

3.  Informative

The distribution used for $\alpha$ are:

1.  Weakly-Informative: ${Normal}(0, 1)$

2.  Vague: ${Normal}(0, 4)$

3.  Informative: ${Normal}(0, 4)$

The distribution used for $\tau$ are:

1.  Weakly-Informative: ${Cauchy}(0, 0.5)$

2.  Vague: ${Cauchy}(0, 4)$

3.  Informative: ${Lognormal}(-1.83, 1.52)$

```{r}
## Create priors for informative and uniform
informative_priors <- c(prior(normal(0,1), class = Intercept),
            prior(cauchy(0,0.5), class = sd))

vague_priors <- c(prior(normal(0,4), class = Intercept),
            prior(cauchy(0,4), class = sd))

turner_etal_priors <- c(prior(normal(0,4), class = Intercept),
            prior(lognormal(-1.83,1.52), class = sd))

# Now we need to create a series of functions to avoid repeating code for each subgroup
## First, the brm function
m.brm_informative <- brm(yi | se(sei) ~ 1 + (1 | author1),
               data = IVdat_dynamic_nrs_24|>
                 mutate(sei = sqrt(vi),
                 author1 = paste(author, year, sep = " ")),
               prior = informative_priors,
               iter = 4000,
               backend = "cmdstanr", 
               cores = parallel::detectCores(),
               chains = 4,
               seed = 123)

m.brm_vague <- update(m.brm_informative, prior = vague_priors)

m.brm_turneretal <- update(m.brm_informative, prior = turner_etal_priors)

# First make a function to extract 95% CrI's
CrI <- function(model){
  model |> 
    brms::fixef(summary = F) |>
    ggdist::median_hdi() |>
    mutate(estimate = paste0(sprintf('%.2f', y), 
                  ' [', sprintf('%.2f', ymin),
                  ', ', sprintf('%.2f', ymax), ']')) |>
    dplyr::select(estimate)
}

## The create a function for prediction intervals:

predictions = function(model){
  
  nd = data.frame(study = "new", sei = 0)
  
  set.seed(123)
  
  brms::posterior_predict(object = model,
                          newdata = nd,
                          re_formula = NULL,
                          allow_new_levels = TRUE,
                          sample_new_levels = "gaussian") |> 
    data.frame() |>
    ggdist::median_hdi() |> 
    rename(y = 1) |>
    mutate(estimate = paste0(sprintf('%.2f', y), 
                  ' [', sprintf('%.2f', .lower),
                  ', ', sprintf('%.2f', .upper), ']')) |>
    dplyr::select(estimate)
}

## Create a function for tau
#Create the text for tau
tau_text <- function(model) {
  
  posterior = 
    model |> 
    tidybayes::tidy_draws() |> 
    ggdist::median_hdi(sd_author1__Intercept) |>
    mutate(estimate = paste0(sprintf('%.2f', sd_author1__Intercept), 
                  ' [', sprintf('%.2f', .lower),
                  ', ', sprintf('%.2f', .upper), ']')) |>
    dplyr::select(estimate)
}


inform_row <- cbind(CrI(m.brm_informative), predictions(m.brm_informative), tau_text(m.brm_informative))
vague_row <- cbind(CrI(m.brm_vague), predictions(m.brm_vague), tau_text(m.brm_vague))
turneretal_row <- cbind(CrI(m.brm_turneretal), predictions(m.brm_turneretal), tau_text(m.brm_turneretal))

combined_tbl <- rbind(inform_row, vague_row, turneretal_row)

## Put row names in (corresponding to each model)
combined_tbl$model <- c("Informative",  "Vague", "Turner et al.")

## rearrange table to put models as first row
combined_tbl <- combined_tbl[c(4, 1:3)]

## Combine the dataframe into a gt()
combined_tbl|>
  gt(rowname_col = "model")|>
  tab_stubhead(label = "Statistical Model")|>
  cols_label(
    estimate = "Mean difference (median [95%CrI])",
    estimate.1 = "Mean difference (median [95%CrI])",
    estimate.2 = "Median [95%CrI])")|>
  tab_spanner(
    label = "\u03C4",
    columns = estimate.2)|>
  tab_spanner(
    label = "Credible interval",
    columns = estimate)|>
  tab_spanner(
    label = "Prediction interval",
    columns = estimate.1)|>
  tab_footnote(
    footnote = paste0("\u03BC prior: ", informative_priors$prior[[1]], "; \u03C4 prior: ", informative_priors$prior[[2]]),
    locations = cells_stub(rows = model == "Informative"),
    placement = "right")|>
  tab_footnote(
    footnote = paste0("\u03BC prior: ", vague_priors$prior[[1]], "; \u03C4 prior: ", vague_priors$prior[[2]]),
    locations = cells_stub(rows = model == "Vague"),
    placement = "right")|>
  tab_footnote(
    footnote = paste0("\u03BC prior: ", turner_etal_priors$prior[[1]], "; \u03C4 prior: ", turner_etal_priors$prior[[2]]),
    locations = cells_stub(rows = model == "Turner et al."),
    placement = "right")|>
  opt_footnote_marks(
    marks = "standard")
```
